## A64Dbg-v1.8.2可以愉快的编写Dex脱壳机了

url：https://mp.weixin.qq.com/s/-oisVrt-3Q2iXxOJCnpLoA



- 发布V1.8.2;
- 1.修复LLDB模式栈帧索引错误的问题；
- 2.修复Debugee主动退出断点未保存的问题；
- 3.修复UraniumVM模式4字节thumb指令停留2次的问题；
- 4.修复UraniumVM模式设置断点单步崩溃的问题；
- 5.修复UraniumVM ARM堆栈参数切换丢失的问题；
- 6.优化断点设置逻辑为异步模式；

这个版本，我们修复了几个关键的Bug，现在你可以用ADCpp脚本愉快的编写Dex脱壳机了。PoC如下：

```
// the hookee
#if __arm__
#define art_DexFile_OpenCommon _ZN3art7DexFile10OpenCommonEPKhjRKNSt3__112basic_stringIcNS3_11char_traitsIcEENS3_9allocatorIcEEEEjPKNS_10OatDexFileEbbPS9_PNS0_12VerifyResultE
#else
#define art_DexFile_OpenCommon _ZN3art7DexFile10OpenCommonEPKhmRKNSt3__112basic_stringIcNS3_11char_traitsIcEENS3_9allocatorIcEEEEjPKNS_10OatDexFileEbbPS9_PNS0_12VerifyResultE
#endif

// the hookee, declare to let A64Dbg dynamically locate it.
extern "C" void art_DexFile_OpenCommon();

// the hookee, save it to call the orig impl.
static void *orig_openCommon = nullptr;

// the hooker, we have simplified the prototype declaration.
std::unique_ptr<void *> openCommon(const uint8_t* base, // 这里是dex的开始
                                   size_t size, // 这里是dex的大小
                                   const std::string& location, // 这里是地址
                                   uint32_t location_checksum,
                                   const void* oat_dex_file, // 如果直接打开文件而不是通过oat文件获得dex，这个参数是kNoOatDexFile，hook打印这个参数就可以判断一些壳是否放弃了oat文件强制以dex解释运行
                                   bool verify,
                                   bool verify_checksum,
                                   std::string* error_msg,
                                   void* verify_result){       
  // you can use the buf2ad api to send the DEX buffer to A64Dbg's python plugin callback        
  printf("I got you~\nDex base: %p, size: 0x%x\n",base,size);
  return ((std::unique_ptr<void *> (*)(const uint8_t *, size_t, const std::string&, uint32_t, const void *, bool, bool, std::string *, void *))
    orig_openCommon)
    (base, size, location, location_checksum, oat_dex_file, 
     verify, verify_checksum, error_msg, verify_result);
}

void adc_main_thread() {
  hook_inline((void *)art_DexFile_OpenCommon, 
              (void *)openCommon,
              &orig_openCommon);
    
  puts("We have hooked art_DexFile_OpenCommon.\n");
}
```

利用调式启动模式让App等待调试附加，然后选择Remote UraniumVM Android模式，附加成功之后，Command编辑框切换为ADCpp模式，然后粘贴上述脚本代码，回车执行：



```
(adcpp) /tmp/dex.poc.cc
We have hooked art_DexFile_OpenCommon.
I got you~
Dex base: 0xd4865000, size: 0x21a060
```

Have fun～


